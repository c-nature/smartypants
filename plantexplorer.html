<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Updated Google Fonts for an earthy/exotic feel -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            /* New earthy background gradient */
            font-family: 'Lora', serif; /* Body text font */
            background: linear-gradient(to bottom right, #8B5E3C, #4A6B5B, #D4E7C5); /* Earthy tones */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 2rem;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .container {
            /* Muted, natural background for the main container */
            background-color: rgba(255, 255, 255, 0.85); /* Slightly transparent white for a softer look */
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 2rem;
            border: 2px solid #6B8E23; /* Earthy green border */
        }

        .header-title {
            /* New font and color for the title */
            font-family: 'Cormorant Garamond', serif; /* Heading font */
            font-size: 3.5rem;
            font-weight: 700; /* Adjusted weight for Cormorant Garamond */
            color: #4A6B5B; /* Forest green title */
            margin-bottom: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .search-input { /* Kept for image upload input styling */
            flex-grow: 1;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            border: 2px solid #A7D9B2; /* Muted green border */
            outline: none;
            font-size: 1.1rem;
            font-family: 'Lora', serif; /* Match body font */
            max-width: 400px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: border-color 0.3s ease;
            color: #333;
            background-color: #F5F5DC; /* Beige input background */
        }

        .search-input:focus {
            border-color: #8B5E3C; /* Earthy brown focus */
        }

        .search-button {
            /* New button colors */
            background-color: #6B8E23; /* Olive green button */
            color: white;
            padding: 0.75rem 1.75rem;
            border-radius: 9999px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }

        .search-button:hover {
            background-color: #4A6B5B; /* Darker forest green on hover */
            transform: translateY(-2px);
        }
        .search-button:active {
            transform: translateY(0);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .plant-card {
            /* Muted background for plant cards */
            background-color: #F5F5DC; /* Beige card background */
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            text-align: left;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s ease-in-out;
            border: 2px solid #8B5E3C; /* Earthy brown border */
            cursor: pointer; /* Make cards clickable */
        }

        .plant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .plant-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
        }

        .plant-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4A6B5B; /* Forest green for plant names */
            margin-bottom: 0.5rem;
        }

        .plant-scientific {
            font-style: italic;
            color: #5A4F4A; /* Darker muted brown for scientific names */
            margin-bottom: 0.5rem;
        }
        .plant-score {
            font-size: 1rem;
            color: #5A4F4A;
            margin-bottom: 0.25rem;
            font-weight: bold;
        }

        .plant-detail {
            font-size: 0.95rem;
            color: #5A4F4A; /* Darker muted brown for details */
            margin-bottom: 0.25rem;
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            font-family: 'Lora', serif; /* Match new body font */
            text-align: center;
        }
        .message-box.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Styles for the image upload section */
        .image-upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px dashed #ccc;
        }

        .image-upload-input {
            border: 2px dashed #A7D9B2;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            width: 100%;
            max-width: 400px;
            font-family: 'Lora', serif;
            color: #4A6B5B;
            transition: border-color 0.3s ease;
        }
        .image-upload-input:hover {
            border-color: #6B8E23;
        }

        .image-preview {
            max-width: 250px;
            max-height: 250px;
            border-radius: 0.75rem;
            border: 2px solid #8B5E3C;
            object-fit: contain;
            margin-top: 1rem;
        }

        /* Detail View Specific Styles */
        .detail-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px;
            margin-top: 2rem;
            margin-bottom: 2rem;
            border: 2px solid #6B8E23;
            text-align: left;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .detail-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.8rem;
            font-weight: 700;
            color: #4A6B5B;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .detail-content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 768px) {
            .detail-content-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .detail-section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #6B8E23;
            margin-bottom: 1rem;
        }

        .detail-info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            color: #5A4F4A;
        }

        .detail-info-item i {
            margin-right: 0.75rem;
            font-size: 1.2rem;
            color: #4A6B5B;
            width: 24px; /* Fixed width for icon alignment */
            text-align: center;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .gallery-grid img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #A7D9B2;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .header-title {
                font-size: 2.2rem;
            }
            .search-input {
                width: 100%;
                max-width: none;
            }
            .search-button {
                width: 100%;
            }
            .detail-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>

    <div id="main-view" class="container">
        <h1 class="header-title">Plant Explorer</h1>

        <!-- Text Search Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-[#4A6B5B] mb-4">Search by Name</h2>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <input type="text" id="plantNameSearchInput" class="search-input" placeholder="Enter plant name (e.g., Rose)">
                <button id="searchPlantByNameBtn" class="search-button">Search Plant</button>
            </div>
        </div>

        <!-- Image Upload Section -->
        <div class="image-upload-section">
            <h2 class="text-2xl font-bold text-[#4A6B5B]">Identify from Image</h2>
            <input type="file" id="imageUploadInput" accept="image/*" class="image-upload-input">
            <button id="identifyImageBtn" class="search-button">Identify Plant from Image</button>
            <img id="uploadedImagePreview" class="image-preview hidden" src="#" alt="Image Preview">
        </div>

        <div id="plantResults" class="results-grid">
            <!-- Plant cards will be inserted here -->
        </div>
        <p id="statusMessage" class="text-gray-600 mt-4"></p>
    </div>

    <!-- Detail View -->
    <div id="detail-view" class="hidden detail-container">
        <header class="detail-header">
            <h2 id="detail-title" class="detail-title"></h2>
            <button id="back-btn" class="search-button">
                <i class="fas fa-arrow-left mr-2"></i> Back to Results
            </button>
        </header>
        <div id="detail-content" class="detail-content-grid">
            <!-- Plant details will be inserted here -->
        </div>
        <div class="mt-8">
            <h3 class="detail-section-title">Photo Gallery</h3>
            <div id="gallery-loader" class="text-center hidden my-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-green-500"></div>
                <p class="mt-4 text-gray-600">Fetching more photos...</p>
            </div>
            <div id="gallery-grid" class="gallery-grid">
                <!-- Gallery images will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Message Box for general messages -->
    <div id="messageBox" class="message-box"></div>

    <audio id="mainClickSoundElement" preload="auto">
        <source src="https://www.soundjay.com/buttons/button-2.mp3" type="audio/mpeg">
        <source src="https://www.soundjay.com/buttons/button-2.ogg" type="audio/ogg">
        <source src="https://www.soundjay.com/buttons/button-2.wav" type="audio/wav"> Your browser does not support the audio element.
    </audio>

    <script>
        // --- Element References ---
        const plantNameSearchInput = document.getElementById('plantNameSearchInput'); // NEW
        const searchPlantByNameBtn = document.getElementById('searchPlantByNameBtn'); // NEW
        const imageUploadInput = document.getElementById('imageUploadInput');
        const identifyImageBtn = document.getElementById('identifyImageBtn');
        const uploadedImagePreview = document.getElementById('uploadedImagePreview');
        const plantResults = document.getElementById('plantResults');
        const statusMessage = document.getElementById('statusMessage');
        const messageBox = document.getElementById('messageBox');
        const mainClickSoundElement = document.getElementById('mainClickSoundElement');

        const mainView = document.getElementById('main-view');
        const detailView = document.getElementById('detail-view');
        const backBtn = document.getElementById('back-btn');
        const detailTitle = document.getElementById('detail-title');
        const detailContent = document.getElementById('detail-content');
        const galleryGrid = document.getElementById('gallery-grid');
        const galleryLoader = document.getElementById('gallery-loader');

        // --- State ---
        let lastPlantSearchResults = [];

        // --- API Configuration ---
        const BACKEND_API_BASE_URL = 'https://smartypantsbe.onrender.com/api/user';
        // IMPORTANT: For text search, we will use the PEXELS_API_PROXY_URL2 which uses PEXELS_API_KEY2
        const PEXELS_API_PROXY_URL_FOR_SEARCH = 'https://smartypantsbe.onrender.com/api/pexels-images2'; 
        
        const wikipediaApiUrl = 'https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*';
        const commonsApiUrl = 'https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*';

        // --- Utility Functions ---
        function playClickSound() {
            if (mainClickSoundElement) {
                mainClickSoundElement.currentTime = 0; 
                mainClickSoundElement.play().catch(e => {
                    console.warn("Error playing click sound:", e);
                });
            } else {
                console.warn("mainClickSoundElement not found. Click sound may not work.");
            }
        }

        function showMessageBox(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        /**
         * Generates a list of potential Wikipedia search terms for a given plant name,
         * prioritizing exact matches, then common suffixes/removals, then disambiguation.
         * @param {string} plantName The original plant name.
         * @returns {string[]} An array of encoded search terms.
         */
        function getWikipediaSearchTerms(plantName) {
            const terms = new Set();
            const lowerCaseName = plantName.toLowerCase();

            // 1. Exact match
            terms.add(plantName);

            // 2. Add common plant type suffixes
            const commonSuffixes = [' plant', ' flower', ' tree', ' herb', ' shrub', ' vine', ' fern', ' moss', ' cactus', ' succulent'];
            for (const suffix of commonSuffixes) {
                if (!lowerCaseName.endsWith(suffix)) {
                    terms.add(plantName + suffix);
                }
            }

            // 3. Remove common plant type suffixes if present
            for (const suffix of commonSuffixes) {
                if (lowerCaseName.endsWith(suffix.trim())) {
                    const strippedName = plantName.substring(0, plantName.length - suffix.length).trim();
                    if (strippedName) terms.add(strippedName);
                }
            }

            // 4. Add common disambiguation (e.g., "Oak (tree)")
            if (!lowerCaseName.includes('(')) {
                for (const suffix of commonSuffixes) {
                    const cleanSuffix = suffix.trim();
                    if (cleanSuffix) {
                        terms.add(`${plantName} (${cleanSuffix})`);
                        if (lowerCaseName.endsWith(suffix.trim())) {
                            const strippedName = plantName.substring(0, plantName.length - cleanSuffix.length).trim();
                            if (strippedName) terms.add(`${strippedName} (${cleanSuffix})`);
                        }
                    }
                }
            }

            // Convert to array and encode
            return Array.from(terms).map(term => encodeURIComponent(term));
        }

        /**
         * Fetches basic plant details from Wikipedia (summary, scientific name, and attempts to parse characteristics).
         * @param {string} plantName The name of the plant to search for.
         * @returns {Object|null} An object containing parsed plant data, or null if not found/invalid.
         */
        async function fetchWikipediaPlantDetails(plantName) {
            const searchTerms = getWikipediaSearchTerms(plantName);

            for (const queryTitle of searchTerms) {
                const url = `${wikipediaApiUrl}&prop=extracts|pageprops|info&exintro=1&explaintext=1&redirects=1&titles=${queryTitle}&inprop=url`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Wikipedia API (plant details) failed for "${decodeURIComponent(queryTitle)}": ${response.status}`);
                        continue; // Try next title
                    }
                    const data = await response.json();
                    const pages = data.query?.pages;

                    if (pages) {
                        const pageId = Object.keys(pages)[0];
                        const page = pages[pageId];

                        if (page && !page.missing) {
                            const description = page.extract || 'No detailed description available from Wikipedia.';
                            const wikipediaUrl = page.fullurl || `https://en.wikipedia.org/wiki/${queryTitle}`;
                            
                            const lowerCaseDescription = description.toLowerCase();
                            const pageTitle = decodeURIComponent(queryTitle).toLowerCase();
                            const firstSentence = lowerCaseDescription.split('.')[0];

                            // Keywords that indicate it's NOT a plant (expanded list)
                            const nonPlantKeywords = [
                                'disambiguation', 'may refer to', 'list of', 'human', 'person', 'organization', 'company', 'building', 
                                'vehicle', 'animal', 'mammal', 'bird', 'fish', 'reptile', 'amphibian', 'insect', 'disease', 'concept', 'event', 'geographic',
                                'software', 'music', 'film', 'book', 'art', 'history', 'mathematics', 'physics', 'chemistry',
                                'engineering', 'technology', 'tool', 'weapon', 'food', 'drink', 'sport', 'game', 'toy', 'clothing',
                                'material', 'chemical', 'element', 'compound', 'structure', 'geology', 'astronomy', 'celestial body',
                                'mythology', 'fictional', 'character', 'album', 'song', 'television series', 'band', 'group',
                                'school', 'bus', 'pencil', 'object', 'abstract', 'theory', 'system', 'fungus', 'bacteria', 'virus'
                            ];

                            // Check if any non-plant keywords are prominently present in title or first sentence
                            const containsNonPlantKeywords = nonPlantKeywords.some(keyword => 
                                pageTitle.includes(keyword) || firstSentence.includes(keyword)
                            );

                            if (containsNonPlantKeywords) {
                                console.log(`Wikipedia page for "${plantName}" (via "${decodeURIComponent(queryTitle)}") contains non-plant keywords. Skipping.`);
                                continue; // Skip this page and try the next search term
                            }

                            // Strong plant indicators
                            const strongPlantIndicators = [
                                'is a species of', 'is a genus of', 'is a family of', 'is an order of', 'is a class of', 'is a phylum of', 
                                'kingdom plantae', 'is a plant', 'is a tree', 'is a flower', 'flora', 'botany', 'vegetation', 'photosynthesis',
                                'annual plant', 'perennial plant', 'biennial plant', 'herbaceous plant', 'woody plant'
                            ];
                            
                            const isStronglyPlantByFirstSentence = strongPlantIndicators.some(indicator => firstSentence.includes(indicator));
                            
                            const originalNameKeywords = plantName.toLowerCase().split(' ').filter(k => k.length > 0);
                            const originalNameInDescription = originalNameKeywords.every(keyword => lowerCaseDescription.includes(keyword));
                            const originalNameInTitle = originalNameKeywords.every(keyword => pageTitle.includes(keyword));

                            const isDefinitelyPlant = isStronglyPlantByFirstSentence || 
                                                     (originalNameInTitle && originalNameInDescription && lowerCaseDescription.length > 100);

                            if (!isDefinitelyPlant) {
                                console.log(`Wikipedia page for "${plantName}" (via "${decodeURIComponent(queryTitle)}") does not meet strict plant criteria. Skipping.`);
                                continue; // Skip this page and try the next search term
                            }

                            // --- Heuristic parsing for plant characteristics ---
                            let scientificName = 'N/A';
                            let family = 'N/A';
                            let genus = 'N/A';
                            let growthPeriod = 'Not specified';
                            let soilType = 'Not specified';
                            let sunExposure = 'Not specified';
                            let waterNeeds = 'Not specified';
                            let nativeRange = ['Not specified'];
                            let flowerColor = 'Not specified';
                            let bloomTime = 'Not specified';

                            // Scientific Name (often in italics in first sentence)
                            const scientificNameMatch = description.match(/\b([A-Z][a-z]+)\s([a-z]+)\b/);
                            if (scientificNameMatch && scientificNameMatch[0]) {
                                scientificName = scientificNameMatch[0];
                            }

                            // Family & Genus (often in infobox or structured text, but we're parsing extract)
                            // More robust regex for family and genus
                            const familyMatch = lowerCaseDescription.match(/(?:family|familia):\s*([a-z\s-]+?)(?:\.|\n|;|,|$)/i);
                            if (familyMatch && familyMatch[1]) {
                                family = familyMatch[1].trim().replace(/\b\w/g, l => l.toUpperCase()); // Capitalize first letter
                                if (family.length > 50) family = family.substring(0, 50) + '...';
                            }
                            const genusMatch = lowerCaseDescription.match(/(?:genus|gÃ©nero):\s*([a-z\s-]+?)(?:\.|\n|;|,|$)/i);
                            if (genusMatch && genusMatch[1]) {
                                genus = genusMatch[1].trim().replace(/\b\w/g, l => l.toUpperCase());
                                if (genus.length > 50) genus = genus.substring(0, 50) + '...';
                            }

                            // Growth Period / Lifecycle
                            const growthPeriodMatch = lowerCaseDescription.match(/(annual|perennial|biennial|deciduous|evergreen)(?: plant)?/i);
                            if (growthPeriodMatch && growthPeriodMatch[1]) {
                                growthPeriod = growthPeriodMatch[1].charAt(0).toUpperCase() + growthPeriodMatch[1].slice(1);
                            }

                            // Soil Type
                            const soilTypeMatch = lowerCaseDescription.match(/(?:prefers|grows in|thrives in|adapted to)\s*(?:(?:well-drained|sandy|loamy|clay|acidic|alkaline|neutral|moist|dry)\s*soil(?:s)?|various soil types)/i);
                            if (soilTypeMatch && soilTypeMatch[0]) {
                                soilType = soilTypeMatch[0].replace(/(?:prefers|grows in|thrives in|adapted to)\s*/i, '').trim();
                                if (soilType.length > 70) soilType = soilType.substring(0, 70) + '...';
                            }

                            // Sun Exposure
                            const sunExposureMatch = lowerCaseDescription.match(/(?:requires|prefers|grows in)\s*(?:full sun|partial shade|deep shade|bright indirect light)/i);
                            if (sunExposureMatch && sunExposureMatch[0]) {
                                sunExposure = sunExposureMatch[0].replace(/(?:requires|prefers|grows in)\s*/i, '').trim();
                                if (sunExposure.length > 50) sunExposure = sunExposure.substring(0, 50) + '...';
                            }

                            // Water Needs
                            const waterNeedsMatch = lowerCaseDescription.match(/(?:drought-tolerant|requires regular watering|needs moist soil|prefers humid conditions)/i);
                            if (waterNeedsMatch && waterNeedsMatch[0]) {
                                waterNeeds = waterNeedsMatch[0];
                                if (waterNeeds.length > 50) waterNeeds = waterNeeds.substring(0, 50) + '...';
                            }

                            // Native Range (similar to locations for animals)
                            let nativeRangeMatch = lowerCaseDescription.match(/(?:native to|found across|distributed throughout|occurs in|range includes)(.*?)(?:\.|\n|;|,|$)/i);
                            if (nativeRangeMatch && nativeRangeMatch[2]) {
                                let extractedRanges = nativeRangeMatch[2].trim().split(/,\s*|\s*and\s*|(?=\s*in\s*(?:the\s*)?[A-Z])/).map(loc => loc.trim()).filter(loc => loc.length > 0);
                                if (extractedRanges.length > 0) {
                                    nativeRange = extractedRanges.slice(0, 3);
                                    if (extractedRanges.length > 3) nativeRange.push('...');
                                }
                            }

                            // Flower Color
                            const flowerColorMatch = lowerCaseDescription.match(/(?:flowers are|blooms are|produces)\s*(?:(?:typically|usually)\s*)?([a-z\s,]+?)\s*(?:(?:in shades of|colored|flowers)|(?:and|or)\s*[a-z\s,]+(?:flowers)?)/i);
                            if (flowerColorMatch && flowerColorMatch[1]) {
                                flowerColor = flowerColorMatch[1].trim();
                                if (flowerColor.length > 50) flowerColor = flowerColor.substring(0, 50) + '...';
                            }

                            // Bloom Time
                            const bloomTimeMatch = lowerCaseDescription.match(/(?:blooms in|flowers in|flowering occurs in|typically flowers from)\s*([a-z\s,]+?)(?:\.|\n|;|,|$)/i);
                            if (bloomTimeMatch && bloomTimeMatch[1]) {
                                bloomTime = bloomTimeMatch[1].trim();
                                if (bloomTime.length > 50) bloomTime = bloomTime.substring(0, 50) + '...';
                            }


                            return {
                                commonName: plantName, // Use the original search term as common name for Wikipedia fallback
                                scientificName: scientificName,
                                family: family,
                                genus: genus,
                                characteristics: {
                                    description: description,
                                    growth_period: growthPeriod,
                                    soil_type: soilType,
                                    sun_exposure: sunExposure,
                                    water_needs: waterNeeds,
                                    native_range: nativeRange.join(', '),
                                    flower_color: flowerColor,
                                    bloom_time: bloomTime
                                },
                                wikipedia_url: wikipediaUrl
                            };
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching plant details from Wikipedia for "${decodeURIComponent(queryTitle)}":`, error);
                }
            }
            return null; // Return null if no suitable Wikipedia page is found after all attempts
        }

        /** Generic helper function to find the best single image match from a list of results. */
        function findBestMatch(photos, plantName, getAltText, getImageUrl, sourceName) {
            if (!photos || photos.length === 0) return null;
            const lowerCasePlantName = plantName.toLowerCase();
            // Try to find a photo where alt text includes the plant name
            for (const photo of photos) {
                const altText = (getAltText(photo) || '').toLowerCase();
                if (altText.includes(lowerCasePlantName)) {
                    console.log(`Found matching image on ${sourceName} with alt/tags: "${altText}"`);
                    return getImageUrl(photo);
                }
            }
            // If no perfect match, return the first image if available.
            if (photos.length > 0) {
                console.log(`No perfect match found for ${plantName} on ${sourceName}, returning first available image.`);
                return getImageUrl(photos[0]);
            }
            return null;
        }

        /** Main image fetching function for a single card image. Prioritizes Pexels (via backend), then Wikipedia. */
        async function fetchPlantImage(plantName) {
            let imageUrl = null;
            try {
                // Try Pexels first via backend proxy (using the PEXELS_API_PROXY_URL2 which is for plants)
                const pexelsQuery = `${plantName} plant`;
                console.log(`Fetching single image from Pexels for query: "${pexelsQuery}"`);
                const pexelsResponse = await fetch(`${PEXELS_API_PROXY_URL_FOR_SEARCH}?query=${encodeURIComponent(pexelsQuery)}&per_page=5`); // Use the correct proxy URL for plants
                if (pexelsResponse.ok) {
                    const pexelsData = await pexelsResponse.json();
                    console.log('Pexels single image raw data:', pexelsData); // Log raw Pexels data
                    imageUrl = findBestMatch(pexelsData.photos, plantName, photo => photo.alt, photo => photo.src.large, "Pexels");
                } else {
                    console.warn(`Pexels proxy failed for single image: ${pexelsResponse.status} - ${await pexelsResponse.text()}`);
                }
            } catch (error) {
                console.error('Error fetching from Pexels proxy for single image:', error);
            }
            
            // Fallback to Wikipedia if Pexels didn't find a good match or backend call failed
            if (!imageUrl) {
                console.log('Pexels image not found or proxy failed, trying Wikipedia for single image...');
                imageUrl = await fetchWikipediaImages(plantName, 1, true); // findOne = true
            }
            return imageUrl;
        }

        /** Fetches multiple images for the gallery view from both Pexels (via backend) and Wikimedia Commons. */
        async function fetchAllGalleryImages(plantName) {
            const pexelsImagesPromise = (async () => {
                try {
                    const pexelsQuery = `${plantName} plant`;
                    console.log(`Fetching gallery images from Pexels for query: "${pexelsQuery}"`);
                    const pexelsResponse = await fetch(`${PEXELS_API_PROXY_URL_FOR_SEARCH}?query=${encodeURIComponent(pexelsQuery)}&per_page=10`); // Use the correct proxy URL for plants
                    if (pexelsResponse.ok) {
                        const pexelsData = await pexelsResponse.json();
                        console.log('Pexels gallery raw data:', pexelsData); // Log raw Pexels data
                        const lowerCasePlantName = plantName.toLowerCase();
                        // Looser filtering for gallery: include if alt or photographer contains *any* keyword from the plant name
                        const keywords = lowerCasePlantName.split(' ').filter(k => k.length > 0);
                        return pexelsData.photos
                            .filter(photo => {
                                const altText = (photo.alt || '').toLowerCase();
                                const photographer = (photo.photographer || '').toLowerCase();
                                return keywords.some(keyword => altText.includes(keyword) || photographer.includes(keyword));
                            })
                            .map(photo => photo.src.large);
                    } else {
                        console.warn(`Pexels proxy failed for gallery: ${pexelsResponse.status} - ${await pexelsResponse.text()}`);
                        return [];
                    }
                } catch (error) {
                    console.error('Error fetching gallery from Pexels proxy:', error);
                    return [];
                }
            })();

            const wikipediaImagesPromise = fetchWikipediaImages(plantName, 10, false); // findOne = false

            const [pexelsImages, wikipediaImages] = await Promise.all([
                pexelsImagesPromise,
                wikipediaImagesPromise
            ]);

            // Combine and deduplicate images
            const allImages = [...(pexelsImages || []), ...(wikipediaImages || [])];
            const uniqueImages = [...new Set(allImages)]; // Remove duplicates
            return uniqueImages;
        }

        /** Fetches images from Wikimedia Commons. Can return one or many. */
        async function fetchWikipediaImages(plantName, count, findOne) {
            const searchTerms = getWikipediaSearchTerms(plantName);
            let imageUrls = [];

            if (findOne) {
                // For a single image (thumbnail) using pageimages property from Wikipedia
                let imageUrl = null;
                for (const queryTitle of searchTerms) {
                    const wikiPageUrl = `${wikipediaApiUrl}&prop=pageimages&pithumbsize=400&titles=${queryTitle}&redirects=1`;
                    try {
                        const response = await fetch(wikiPageUrl);
                        const data = await response.json();
                        const pages = data.query?.pages;
                        const pageId = pages ? Object.keys(pages)[0] : null;
                        const page = pageId ? pages[pageId] : null;

                        if (page && !page.missing && page.thumbnail?.source) {
                            imageUrl = page.thumbnail.source;
                            console.log(`Found single image on Wikipedia for ${plantName} (via "${decodeURIComponent(queryTitle)}" thumbnail): ${imageUrl}`);
                            break; // Found an image, stop trying other terms
                        }
                    } catch (error) {
                        console.error(`Error fetching single image from Wikipedia for "${decodeURIComponent(queryTitle)}":`, error);
                    }
                }

                // Fallback to Wikimedia Commons search if no thumbnail found from Wikipedia page
                if (!imageUrl) {
                    console.log('Wikipedia page thumbnail not found, trying Wikimedia Commons for single image...');
                    const searchUrl = `${commonsApiUrl}&list=search&srsearch=${encodeURIComponent(plantName)}&srnamespace=6&srlimit=20&srwhat=text&srprop=snippet`; 
                    try {
                        const searchResponse = await fetch(searchUrl);
                        if (!searchResponse.ok) { console.warn(`Wikimedia Commons search failed for single image: ${searchResponse.status}`); return null; }
                        const searchData = await searchResponse.json();
                        const searchResults = searchData.query?.search;

                        if (searchResults && searchResults.length > 0) {
                            const lowerCasePlantName = plantName.toLowerCase();
                            const keywords = lowerCasePlantName.split(' ').filter(k => k.length > 0);

                            const filteredResults = searchResults.filter(result => {
                                const title = result.title.toLowerCase();
                                const snippet = result.snippet ? result.snippet.toLowerCase() : '';
                                const isImage = /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(result.title);
                                
                                const containsAllKeywords = keywords.every(keyword => 
                                    title.includes(keyword) || snippet.includes(keyword)
                                );
                                return isImage && containsAllKeywords;
                            });

                            if (filteredResults.length > 0) {
                                const bestMatchTitle = encodeURIComponent(filteredResults[0].title);
                                const infoUrl = `${commonsApiUrl}&prop=imageinfo&iiprop=url&titles=${bestMatchTitle}&redirects=1`;
                                try {
                                    const infoResponse = await fetch(infoUrl);
                                    const infoData = await infoResponse.json();
                                    const infoPages = infoData.query?.pages;
                                    if (infoPages) {
                                        const infoPageId = Object.keys(infoPages)[0];
                                        const infoPage = infoPages[infoPageId];
                                        if (infoPage.imageinfo && infoPage.imageinfo[0]?.url) {
                                            imageUrl = infoPage.imageinfo[0].url;
                                            console.log(`Found single image on Wikimedia Commons for ${plantName}: ${imageUrl}`);
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error fetching image info from Wikimedia Commons:', error);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching single image from Wikimedia Commons:', error);
                    }
                }
                return imageUrl;

            } else {
                // For multiple gallery images, search Wikimedia Commons directly for relevant files
                let allFilteredResults = [];
                const processedTitles = new Set(); // To avoid duplicate image fetching

                for (const query of searchTerms) {
                    const searchUrl = `${commonsApiUrl}&list=search&srsearch=${query}&srnamespace=6&srlimit=${count * 3}&srwhat=text&srprop=snippet`; 
                    try {
                        const searchResponse = await fetch(searchUrl);
                        if (!searchResponse.ok) { console.warn(`Wikimedia Commons search failed for query "${decodeURIComponent(query)}": ${searchResponse.status}`); continue; }
                        const searchData = await searchResponse.json();
                        const searchResults = searchData.query?.search;

                        if (searchResults && searchResults.length > 0) {
                            const lowerCasePlantName = plantName.toLowerCase();
                            const keywords = lowerCasePlantName.split(' ').filter(k => k.length > 0);

                            const filteredResults = searchResults.filter(result => {
                                const title = result.title.toLowerCase();
                                const snippet = result.snippet ? snippet.toLowerCase() : '';
                                const isImage = /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(result.title);
                                
                                const containsAllKeywords = keywords.every(keyword => 
                                    title.includes(keyword) || snippet.includes(keyword)
                                );
                                
                                const isRelevant = (keywords.length > 1 && containsAllKeywords) || 
                                                 (keywords.length === 1 && (title.includes(keywords[0]) || snippet.includes(keywords[0])));

                                return isImage && isRelevant && !processedTitles.has(result.title);
                            });
                            
                            filteredResults.forEach(res => {
                                if (!processedTitles.has(res.title)) {
                                    allFilteredResults.push(res);
                                    processedTitles.add(res.title);
                                }
                            });

                            if (allFilteredResults.length >= count) break; // Stop if we have enough
                        }
                    } catch (error) {
                        console.error(`Error fetching gallery images from Wikimedia Commons for query "${decodeURIComponent(query)}":`, error);
                    }
                }

                const imageTitlesToFetch = allFilteredResults
                    .slice(0, count) // Take only the desired 'count' after strict filtering
                    .map(result => encodeURIComponent(result.title))
                    .join('|');

                if (imageTitlesToFetch) {
                    const infoUrl = `${commonsApiUrl}&prop=imageinfo&iiprop=url&titles=${imageTitlesToFetch}&redirects=1`;
                    try {
                        const infoResponse = await fetch(infoUrl);
                        if (!infoResponse.ok) { console.warn(`Wikimedia Commons imageinfo failed: ${infoResponse.status}`); return []; }
                        const infoData = await infoResponse.json();
                        const infoPages = infoData.query?.pages;

                        if (infoPages) {
                            for (const infoPageId in infoPages) {
                                const infoPage = infoPages[infoPageId];
                                if (infoPage.imageinfo && infoPage.imageinfo[0]?.url) {
                                    imageUrls.push(infoPage.imageinfo[0].url);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching gallery image URLs from Wikimedia Commons:', error);
                    }
                }
                console.log(`Found ${imageUrls.length} gallery images from Wikimedia Commons for ${plantName}.`);
                return imageUrls;
            }
        }

        /**
         * Renders plant cards in the results grid.
         * @param {Array} plants An array of plant objects.
         * @param {boolean} isIdentificationResult True if results are from image identification (show score).
         */
        async function renderPlantCards(plants, isIdentificationResult = false) {
            plantResults.innerHTML = ''; // Clear previous results
            if (plants.length === 0) {
                statusMessage.textContent = `No plants found. Try uploading a different image.`;
                showMessageBox(`No identification found.`);
                return;
            }

            statusMessage.textContent = `Found ${plants.length} results.`;
            for (const plant of plants) {
                const card = document.createElement('div');
                card.className = 'plant-card';
                card.dataset.plantName = plant.commonName; // Store name for detail view lookup

                let scoreHtml = '';
                if (isIdentificationResult && plant.score !== 'N/A') {
                    scoreHtml = `<p class="plant-score">Confidence: ${plant.score}%</p>`;
                }

                // Use the PEXELS_API_PROXY_URL_FOR_SEARCH for fetching the main card image for both search types
                const imageUrl = await fetchPlantImage(plant.commonName);
                let imageHtml = `<img src="${imageUrl || 'https://placehold.co/200x200/cccccc/000000?text=No+Image'}" alt="${plant.commonName || plant.scientificName}" class="plant-image" onerror="this.onerror=null;this.src='https://placehold.co/200x200/cccccc/000000?text=No+Image';">`;
                
                card.innerHTML = `
                    ${imageHtml}
                    <h3 class="plant-name">${plant.commonName || 'N/A'}</h3>
                    <p class="plant-scientific">${plant.scientificName || 'N/A'}</p>
                    ${scoreHtml}
                    <p class="plant-detail">Family: ${plant.family || 'N/A'}</p>
                    <p class="plant-detail">Genus: ${plant.genus || 'N/A'}</p>
                `;
                plantResults.appendChild(card);
            }

            // Add event listeners to the new clickable cards
            document.querySelectorAll('.plant-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    playClickSound();
                    const plantName = e.currentTarget.dataset.plantName;
                    const plantData = lastPlantSearchResults.find(p => p.commonName === plantName);
                    if (plantData) {
                        showDetailView(plantData);
                    } else {
                        showMessageBox('Could not find detailed data for this plant.');
                    }
                });
            });
        }

        // --- Image Identification Function (using PlantNet via backend) ---
        async function identifyPlantFromImage() {
            playClickSound();
            if (!imageUploadInput.files || imageUploadInput.files.length === 0) {
                showMessageBox('Please select an image file first.');
                return;
            }

            const imageFile = imageUploadInput.files[0];
            const formData = new FormData();
            formData.append('image', imageFile); // 'image' is the field name expected by multer on backend

            plantResults.innerHTML = ''; // Clear previous results
            statusMessage.textContent = 'Identifying plant from image...';
            identifyImageBtn.disabled = true;
            searchPlantByNameBtn.disabled = true; // Disable text search during image identification

            // Show image preview
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImagePreview.src = e.target.result;
                uploadedImagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(imageFile);

            try {
                const response = await fetch(`${BACKEND_API_BASE_URL}/plant/identify`, {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (!response.ok || data.status !== 'Success') {
                    const errorMessage = data.message || `Error: ${response.status} ${response.statusText}`;
                    statusMessage.textContent = `Identification failed: ${errorMessage}`;
                    showMessageBox(`Identification failed: ${errorMessage}`);
                    return;
                }

                if (data.data && data.data.length > 0) {
                    statusMessage.textContent = `Enriching data for identified plants...`;
                    // Enrich each identified plant with Wikipedia details and store
                    lastPlantSearchResults = await Promise.all(data.data.map(async (plant) => {
                        const wikipediaDetails = await fetchWikipediaPlantDetails(plant.commonName || plant.scientificName);
                        if (wikipediaDetails) {
                            // Merge PlantNet data with Wikipedia data, prioritizing PlantNet for core ID
                            return {
                                ...plant,
                                commonName: plant.commonName || wikipediaDetails.commonName,
                                scientificName: plant.scientificName || wikipediaDetails.scientificName,
                                family: plant.family || wikipediaDetails.family,
                                genus: plant.genus || wikipediaDetails.genus,
                                characteristics: {
                                    ...wikipediaDetails.characteristics, // Wikipedia provides richer characteristics
                                    ...plant.characteristics // Overlay with any PlantNet specific characteristics if desired
                                },
                                wikipedia_url: wikipediaDetails.wikipedia_url
                            };
                        }
                        return plant; // Return original PlantNet data if Wikipedia details not found
                    }));
                    
                    renderPlantCards(lastPlantSearchResults, true); // Render enriched results (with score)
                } else {
                    statusMessage.textContent = `No confident identification found for the image.`;
                    showMessageBox(`No identification found.`);
                }

            } catch (error) {
                console.error('Frontend image identification error:', error);
                statusMessage.textContent = 'An error occurred during image identification. Please try again.';
                showMessageBox('Network error during image identification.');
            } finally {
                identifyImageBtn.disabled = false;
                searchPlantByNameBtn.disabled = false; // Re-enable text search
            }
        }

        // --- NEW: Text Search Functionality ---
        async function searchPlantsByName() {
            playClickSound();
            const plantName = plantNameSearchInput.value.trim();
            if (!plantName) {
                showMessageBox('Please enter a plant name to search.');
                return;
            }

            plantResults.innerHTML = ''; // Clear previous results
            statusMessage.textContent = `Searching for "${plantName}"...`;
            identifyImageBtn.disabled = true; // Disable image search during text search
            searchPlantByNameBtn.disabled = true;

            // Hide image preview when performing text search
            uploadedImagePreview.classList.add('hidden');
            uploadedImagePreview.src = '#'; // Clear the image source

            try {
                const wikipediaDetails = await fetchWikipediaPlantDetails(plantName);

                if (wikipediaDetails) {
                    lastPlantSearchResults = [wikipediaDetails]; // Store as an array for consistent rendering
                    renderPlantCards(lastPlantSearchResults, false); // Render without score
                } else {
                    statusMessage.textContent = `No detailed information found for "${plantName}" from Wikipedia.`;
                    showMessageBox(`No information found for "${plantName}".`);
                }

            } catch (error) {
                console.error('Frontend text search error:', error);
                statusMessage.textContent = 'An error occurred during text search. Please try again.';
                showMessageBox('Network error during text search.');
            } finally {
                identifyImageBtn.disabled = false; // Re-enable image search
                searchPlantByNameBtn.disabled = false;
            }
        }


        // --- Event Listeners ---
        identifyImageBtn.addEventListener('click', identifyPlantFromImage);
        imageUploadInput.addEventListener('change', () => {
            if (imageUploadInput.files && imageUploadInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImagePreview.src = e.target.result;
                    uploadedImagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(imageUploadInput.files[0]);
            } else {
                uploadedImagePreview.classList.add('hidden');
                uploadedImagePreview.src = '#';
            }
        });

        // NEW: Event listeners for text search
        searchPlantByNameBtn.addEventListener('click', searchPlantsByName);
        plantNameSearchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                searchPlantsByName();
            }
        });

        backBtn.addEventListener('click', () => {
            playClickSound();
            detailView.classList.add('hidden');
            mainView.classList.remove('hidden');
            // Clear detail view content when going back
            detailTitle.textContent = '';
            detailContent.innerHTML = '';
            galleryGrid.innerHTML = '';
        });

        // Initial message
        document.addEventListener('DOMContentLoaded', () => {
            statusMessage.textContent = 'Upload an image or enter a name to identify plants!';
        });
    </script>
</body>
</html>
